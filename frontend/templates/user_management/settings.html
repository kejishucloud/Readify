<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户设置 - Readify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .settings-card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .settings-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }
        .btn-test:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            color: white;
        }
        .alert {
            margin-top: 10px;
        }
        .provider-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="settings-container">
            <h1 class="mb-4"><i class="fas fa-cog"></i> 用户设置</h1>
            
            <!-- AI配置卡片 -->
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> AI服务配置</h5>
                </div>
                <div class="card-body">
                    <form id="aiConfigForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="provider">AI提供商</label>
                                    <select class="form-control" id="provider" name="provider">
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic (Claude)</option>
                                        <option value="google">Google (Gemini)</option>
                                        <option value="azure">Azure OpenAI</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="model_id">模型ID</label>
                                    <input type="text" class="form-control" id="model_id" name="model_id" 
                                           placeholder="例如: gpt-3.5-turbo">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="api_url">API地址</label>
                            <input type="url" class="form-control" id="api_url" name="api_url" 
                                   placeholder="例如: https://api.openai.com/v1">
                        </div>
                        
                        <div class="form-group">
                            <label for="api_key">API密钥</label>
                            <input type="password" class="form-control" id="api_key" name="api_key" 
                                   placeholder="输入您的API密钥">
                            <small class="text-muted">密钥将被安全存储，不会显示在界面上</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="max_tokens">最大令牌数</label>
                                    <input type="number" class="form-control" id="max_tokens" name="max_tokens" 
                                           min="100" max="32000" value="4000">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="temperature">温度参数</label>
                                    <input type="number" class="form-control" id="temperature" name="temperature" 
                                           min="0" max="2" step="0.1" value="0.7">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="timeout">超时时间(秒)</label>
                                    <input type="number" class="form-control" id="timeout" name="timeout" 
                                           min="5" max="120" value="30">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="is_active" name="is_active">
                            <label class="form-check-label" for="is_active">
                                启用AI服务
                            </label>
                        </div>
                        
                        <div class="provider-info" id="providerInfo">
                            <!-- 提供商信息将在这里显示 -->
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存配置
                            </button>
                            <button type="button" class="btn btn-test" id="testConfigBtn">
                                <i class="fas fa-vial"></i> 测试配置
                            </button>
                        </div>
                        
                        <div id="aiConfigAlert"></div>
                    </form>
                </div>
            </div>
            
            <!-- 用户偏好设置卡片 -->
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-palette"></i> 偏好设置</h5>
                </div>
                <div class="card-body">
                    <form id="preferencesForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="theme">主题</label>
                                    <select class="form-control" id="theme" name="theme">
                                        <option value="light">浅色主题</option>
                                        <option value="dark">深色主题</option>
                                        <option value="auto">自动</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="language">界面语言</label>
                                    <select class="form-control" id="language" name="language">
                                        <option value="zh">中文</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="user_timezone">时区</label>
                                    <select class="form-control" id="user_timezone" name="user_timezone">
                                        <option value="Asia/Shanghai">Asia/Shanghai</option>
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New_York</option>
                                        <option value="Europe/London">Europe/London</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="email_notifications" name="email_notifications">
                                    <label class="form-check-label" for="email_notifications">
                                        邮件通知
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="push_notifications" name="push_notifications">
                                    <label class="form-check-label" for="push_notifications">
                                        推送通知
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="fas fa-save"></i> 保存偏好设置
                        </button>
                        
                        <div id="preferencesAlert"></div>
                    </form>
                </div>
            </div>
            
            <!-- 用户配置文件卡片 -->
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user"></i> 个人资料</h5>
                </div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="form-group">
                            <label for="bio">个人简介</label>
                            <textarea class="form-control" id="bio" name="bio" rows="3" 
                                      placeholder="介绍一下自己..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="location">位置</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           placeholder="例如: 北京, 中国">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="website">个人网站</label>
                                    <input type="url" class="form-control" id="website" name="website" 
                                           placeholder="https://example.com">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="birth_date">出生日期</label>
                            <input type="date" class="form-control" id="birth_date" name="birth_date">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存个人资料
                        </button>
                        
                        <div id="profileAlert"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 提供商信息
        const providerInfo = {
            'openai': {
                name: 'OpenAI',
                description: '支持GPT-3.5、GPT-4等模型',
                defaultUrl: 'https://api.openai.com/v1',
                defaultModel: 'gpt-3.5-turbo',
                docs: 'https://platform.openai.com/docs'
            },
            'anthropic': {
                name: 'Anthropic',
                description: '支持Claude系列模型',
                defaultUrl: 'https://api.anthropic.com',
                defaultModel: 'claude-3-sonnet-20240229',
                docs: 'https://docs.anthropic.com'
            },
            'google': {
                name: 'Google',
                description: '支持Gemini系列模型',
                defaultUrl: 'https://generativelanguage.googleapis.com/v1beta',
                defaultModel: 'gemini-pro',
                docs: 'https://ai.google.dev/docs'
            },
            'azure': {
                name: 'Azure OpenAI',
                description: '微软Azure上的OpenAI服务',
                defaultUrl: 'https://your-resource.openai.azure.com',
                defaultModel: 'gpt-35-turbo',
                docs: 'https://docs.microsoft.com/azure/cognitive-services/openai'
            },
            'custom': {
                name: '自定义',
                description: '支持任何兼容OpenAI API格式的服务',
                defaultUrl: 'https://api.example.com/v1',
                defaultModel: 'custom-model',
                docs: ''
            }
        };

        // 页面加载时获取配置
        document.addEventListener('DOMContentLoaded', function() {
            loadAIConfig();
            loadPreferences();
            loadProfile();
            
            // 绑定事件
            document.getElementById('provider').addEventListener('change', updateProviderInfo);
            document.getElementById('aiConfigForm').addEventListener('submit', saveAIConfig);
            document.getElementById('testConfigBtn').addEventListener('click', testAIConfig);
            document.getElementById('preferencesForm').addEventListener('submit', savePreferences);
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
        });

        // 加载AI配置
        function loadAIConfig() {
            fetch('/user/ai-config/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.config;
                        document.getElementById('provider').value = config.provider;
                        document.getElementById('api_url').value = config.api_url;
                        document.getElementById('model_id').value = config.model_id;
                        document.getElementById('max_tokens').value = config.max_tokens;
                        document.getElementById('temperature').value = config.temperature;
                        document.getElementById('timeout').value = config.timeout;
                        document.getElementById('is_active').checked = config.is_active;
                        
                        updateProviderInfo();
                    }
                })
                .catch(error => console.error('加载AI配置失败:', error));
        }

        // 更新提供商信息
        function updateProviderInfo() {
            const provider = document.getElementById('provider').value;
            const info = providerInfo[provider];
            const infoDiv = document.getElementById('providerInfo');
            
            if (info) {
                // 更新默认值
                document.getElementById('api_url').value = info.defaultUrl;
                document.getElementById('model_id').value = info.defaultModel;
                
                // 显示提供商信息
                infoDiv.innerHTML = `
                    <strong>${info.name}</strong><br>
                    ${info.description}<br>
                    ${info.docs ? `<a href="${info.docs}" target="_blank">查看文档</a>` : ''}
                `;
            }
        }

        // 保存AI配置
        function saveAIConfig(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.is_active = document.getElementById('is_active').checked;
            
            fetch('/user/ai-config/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                showAlert('aiConfigAlert', data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAlert('aiConfigAlert', '保存失败', 'danger');
                console.error('保存AI配置失败:', error);
            });
        }

        // 测试AI配置
        function testAIConfig() {
            const btn = document.getElementById('testConfigBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
            
            fetch('/user/ai-config/test/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                showAlert('aiConfigAlert', data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAlert('aiConfigAlert', '测试失败', 'danger');
                console.error('测试AI配置失败:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-vial"></i> 测试配置';
            });
        }

        // 加载偏好设置
        function loadPreferences() {
            // 这里可以添加加载偏好设置的代码
        }

        // 保存偏好设置
        function savePreferences(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.email_notifications = document.getElementById('email_notifications').checked;
            data.push_notifications = document.getElementById('push_notifications').checked;
            
            fetch('/user/preferences/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                showAlert('preferencesAlert', data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAlert('preferencesAlert', '保存失败', 'danger');
                console.error('保存偏好设置失败:', error);
            });
        }

        // 加载个人资料
        function loadProfile() {
            // 这里可以添加加载个人资料的代码
        }

        // 保存个人资料
        function saveProfile(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/user/profile/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                showAlert('profileAlert', data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAlert('profileAlert', '保存失败', 'danger');
                console.error('保存个人资料失败:', error);
            });
        }

        // 显示提示信息
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // 获取CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html> 