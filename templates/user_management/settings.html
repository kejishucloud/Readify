{% extends 'base.html' %}
{% load static %}

{% block title %}用户设置{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .settings-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .settings-section h5 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 5px;
    }
    
    .voice-test-btn {
        margin-left: 10px;
    }
    
    .range-value {
        font-weight: bold;
        color: #007bff;
        margin-left: 10px;
    }
    
    .settings-actions {
        text-align: center;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <h2 class="mb-4">
        <i class="fas fa-cog"></i>
        用户设置
    </h2>
    
    <form id="settingsForm">
        {% csrf_token %}
        
        <!-- 基本设置 -->
        <div class="settings-section">
            <h5>
                <i class="fas fa-user"></i>
                基本设置
            </h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">主题</label>
                        <select class="form-select" name="theme" id="theme">
                            <option value="light" {% if preferences.theme == 'light' %}selected{% endif %}>浅色主题</option>
                            <option value="dark" {% if preferences.theme == 'dark' %}selected{% endif %}>深色主题</option>
                            <option value="auto" {% if preferences.theme == 'auto' %}selected{% endif %}>自动</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">界面语言</label>
                        <select class="form-select" name="language" id="language">
                            <option value="zh" {% if preferences.language == 'zh' %}selected{% endif %}>中文</option>
                            <option value="en" {% if preferences.language == 'en' %}selected{% endif %}>English</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="email_notifications" id="emailNotifications" 
                               {% if preferences.email_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="emailNotifications">
                            邮件通知
                        </label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="push_notifications" id="pushNotifications" 
                               {% if preferences.push_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="pushNotifications">
                            推送通知
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 语音设置 -->
        <div class="settings-section">
            <h5>
                <i class="fas fa-volume-up"></i>
                语音设置
            </h5>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="voice_enabled" id="voiceEnabled" 
                       {% if preferences.voice_enabled %}checked{% endif %}>
                <label class="form-check-label" for="voiceEnabled">
                    启用语音功能
                </label>
            </div>
            
            <div id="voiceSettings" {% if not preferences.voice_enabled %}style="display: none;"{% endif %}>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">语音引擎</label>
                            <select class="form-select" name="voice_engine" id="voiceEngine">
                                <option value="system" {% if preferences.voice_engine == 'system' %}selected{% endif %}>系统语音</option>
                                <option value="azure" {% if preferences.voice_engine == 'azure' %}selected{% endif %}>Azure语音</option>
                                <option value="google" {% if preferences.voice_engine == 'google' %}selected{% endif %}>Google语音</option>
                                <option value="baidu" {% if preferences.voice_engine == 'baidu' %}selected{% endif %}>百度语音</option>
                                <option value="iflytek" {% if preferences.voice_engine == 'iflytek' %}selected{% endif %}>科大讯飞</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">语音语言</label>
                            <select class="form-select" name="voice_language" id="voiceLanguage">
                                <option value="zh-CN" {% if preferences.voice_language == 'zh-CN' %}selected{% endif %}>中文(普通话)</option>
                                <option value="zh-TW" {% if preferences.voice_language == 'zh-TW' %}selected{% endif %}>中文(台湾)</option>
                                <option value="zh-HK" {% if preferences.voice_language == 'zh-HK' %}selected{% endif %}>中文(香港)</option>
                                <option value="en-US" {% if preferences.voice_language == 'en-US' %}selected{% endif %}>英语(美国)</option>
                                <option value="en-GB" {% if preferences.voice_language == 'en-GB' %}selected{% endif %}>英语(英国)</option>
                                <option value="ja-JP" {% if preferences.voice_language == 'ja-JP' %}selected{% endif %}>日语</option>
                                <option value="ko-KR" {% if preferences.voice_language == 'ko-KR' %}selected{% endif %}>韩语</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">语音类型</label>
                            <select class="form-select" name="voice_type" id="voiceType">
                                <option value="female" {% if preferences.voice_type == 'female' %}selected{% endif %}>女声</option>
                                <option value="male" {% if preferences.voice_type == 'male' %}selected{% endif %}>男声</option>
                                <option value="child" {% if preferences.voice_type == 'child' %}selected{% endif %}>童声</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">语音速度</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1" name="voice_speed" id="voiceSpeed" 
                                       min="0.5" max="2.0" step="0.1" value="{{ preferences.voice_speed|default:1.0 }}">
                                <span class="range-value" id="voiceSpeedValue">{{ preferences.voice_speed|default:1.0 }}x</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">音调高低</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1" name="voice_pitch" id="voicePitch" 
                                       min="0.5" max="2.0" step="0.1" value="{{ preferences.voice_pitch|default:1.0 }}">
                                <span class="range-value" id="voicePitchValue">{{ preferences.voice_pitch|default:1.0 }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">音量大小</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1" name="voice_volume" id="voiceVolume" 
                                       min="0.1" max="2.0" step="0.1" value="{{ preferences.voice_volume|default:1.0 }}">
                                <span class="range-value" id="voiceVolumeValue">{{ preferences.voice_volume|default:1.0 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="auto_read" id="autoRead" 
                                   {% if preferences.auto_read %}checked{% endif %}>
                            <label class="form-check-label" for="autoRead">
                                自动朗读
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">自动朗读延迟(秒)</label>
                            <input type="number" class="form-control" name="auto_read_delay" id="autoReadDelay" 
                                   min="1" max="10" value="{{ preferences.auto_read_delay|default:3 }}">
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary voice-test-btn" id="testVoice">
                        <i class="fas fa-play"></i>
                        测试语音
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 阅读设置 -->
        <div class="settings-section">
            <h5>
                <i class="fas fa-book-open"></i>
                阅读设置
            </h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">字体大小</label>
                        <div class="d-flex align-items-center">
                            <input type="range" class="form-range flex-grow-1" name="reading_font_size" id="readingFontSize" 
                                   min="12" max="24" step="1" value="{{ preferences.reading_font_size|default:16 }}">
                            <span class="range-value" id="readingFontSizeValue">{{ preferences.reading_font_size|default:16 }}px</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">行高</label>
                        <div class="d-flex align-items-center">
                            <input type="range" class="form-range flex-grow-1" name="reading_line_height" id="readingLineHeight" 
                                   min="1.2" max="2.0" step="0.1" value="{{ preferences.reading_line_height|default:1.6 }}">
                            <span class="range-value" id="readingLineHeightValue">{{ preferences.reading_line_height|default:1.6 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">阅读背景</label>
                        <select class="form-select" name="reading_background" id="readingBackground">
                            <option value="white" {% if preferences.reading_background == 'white' %}selected{% endif %}>白色</option>
                            <option value="beige" {% if preferences.reading_background == 'beige' %}selected{% endif %}>米色</option>
                            <option value="green" {% if preferences.reading_background == 'green' %}selected{% endif %}>护眼绿</option>
                            <option value="dark" {% if preferences.reading_background == 'dark' %}selected{% endif %}>深色</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">阅读模式</label>
                        <select class="form-select" name="reading_mode" id="readingMode">
                            <option value="normal" {% if preferences.reading_mode == 'normal' %}selected{% endif %}>普通模式</option>
                            <option value="focus" {% if preferences.reading_mode == 'focus' %}selected{% endif %}>专注模式</option>
                            <option value="immersive" {% if preferences.reading_mode == 'immersive' %}selected{% endif %}>沉浸模式</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI助手设置 -->
        <div class="settings-section">
            <h5>
                <i class="fas fa-robot"></i>
                AI助手设置
            </h5>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="ai_assistant_enabled" id="aiAssistantEnabled" 
                       {% if preferences.ai_assistant_enabled %}checked{% endif %}>
                <label class="form-check-label" for="aiAssistantEnabled">
                    启用AI助手
                </label>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="ai_auto_summary" id="aiAutoSummary" 
                               {% if preferences.ai_auto_summary %}checked{% endif %}>
                        <label class="form-check-label" for="aiAutoSummary">
                            自动生成章节总结
                        </label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="ai_context_memory" id="aiContextMemory" 
                               {% if preferences.ai_context_memory %}checked{% endif %}>
                        <label class="form-check-label" for="aiContextMemory">
                            AI上下文记忆
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-group mt-3">
                <label class="form-label">AI回答风格</label>
                <select class="form-select" name="ai_response_style" id="aiResponseStyle">
                    <option value="concise" {% if preferences.ai_response_style == 'concise' %}selected{% endif %}>简洁</option>
                    <option value="balanced" {% if preferences.ai_response_style == 'balanced' %}selected{% endif %}>平衡</option>
                    <option value="detailed" {% if preferences.ai_response_style == 'detailed' %}selected{% endif %}>详细</option>
                </select>
            </div>
        </div>
        
        <!-- AI配置设置 -->
        <div class="settings-section">
            <h5>
                <i class="fas fa-cogs"></i>
                AI配置
            </h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">AI提供商</label>
                        <select class="form-select" name="ai_provider" id="aiProvider">
                            <option value="openai" {% if ai_config.provider == 'openai' %}selected{% endif %}>OpenAI</option>
                            <option value="anthropic" {% if ai_config.provider == 'anthropic' %}selected{% endif %}>Anthropic</option>
                            <option value="google" {% if ai_config.provider == 'google' %}selected{% endif %}>Google</option>
                            <option value="azure" {% if ai_config.provider == 'azure' %}selected{% endif %}>Azure OpenAI</option>
                            <option value="custom" {% if ai_config.provider == 'custom' %}selected{% endif %}>自定义</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">模型ID</label>
                        <input type="text" class="form-control" name="ai_model_id" id="aiModelId" 
                               value="{{ ai_config.model_id }}" placeholder="gpt-3.5-turbo">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">API地址</label>
                <input type="url" class="form-control" name="ai_api_url" id="aiApiUrl" 
                       value="{{ ai_config.api_url }}" placeholder="https://api.openai.com/v1">
            </div>
            
            <div class="form-group">
                <label class="form-label">API密钥</label>
                <input type="password" class="form-control" name="ai_api_key" id="aiApiKey" 
                       placeholder="输入新的API密钥（留空保持不变）">
                <small class="form-text text-muted">
                    {% if ai_config.api_key %}已配置API密钥{% else %}未配置API密钥{% endif %}
                </small>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">最大令牌数</label>
                        <input type="number" class="form-control" name="ai_max_tokens" id="aiMaxTokens" 
                               min="100" max="8000" value="{{ ai_config.max_tokens }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">温度参数</label>
                        <input type="number" class="form-control" name="ai_temperature" id="aiTemperature" 
                               min="0" max="2" step="0.1" value="{{ ai_config.temperature }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">超时时间(秒)</label>
                        <input type="number" class="form-control" name="ai_timeout" id="aiTimeout" 
                               min="10" max="120" value="{{ ai_config.timeout }}">
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-outline-primary" id="testAI">
                    <i class="fas fa-flask"></i>
                    测试AI配置
                </button>
            </div>
        </div>
        
        <!-- 保存按钮 -->
        <div class="settings-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i>
                保存设置
            </button>
            <button type="button" class="btn btn-secondary btn-lg ms-3" id="resetSettings">
                <i class="fas fa-undo"></i>
                重置设置
            </button>
        </div>
    </form>
</div>

<!-- 加载提示 -->
<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <div class="mt-2" id="loadingText">处理中...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 范围滑块值更新
    const rangeInputs = document.querySelectorAll('input[type="range"]');
    rangeInputs.forEach(input => {
        const valueSpan = document.getElementById(input.id + 'Value');
        if (valueSpan) {
            input.addEventListener('input', function() {
                let value = this.value;
                if (this.id === 'voiceSpeed') {
                    value += 'x';
                } else if (this.id === 'readingFontSize') {
                    value += 'px';
                }
                valueSpan.textContent = value;
            });
        }
    });
    
    // 语音功能开关
    const voiceEnabled = document.getElementById('voiceEnabled');
    const voiceSettings = document.getElementById('voiceSettings');
    
    voiceEnabled.addEventListener('change', function() {
        voiceSettings.style.display = this.checked ? 'block' : 'none';
    });
    
    // 测试语音
    document.getElementById('testVoice').addEventListener('click', function() {
        const testText = '这是一个语音测试，您可以听到当前的语音设置效果。';
        // 这里可以调用TTS API进行测试
        alert('语音测试功能将在后续版本中实现');
    });
    
    // 测试AI配置
    document.getElementById('testAI').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
            
            const response = await fetch('/user/ai-config/test/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('AI配置测试成功！');
            } else {
                alert('AI配置测试失败：' + data.message);
            }
        } catch (error) {
            alert('测试失败：' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
    
    // 保存设置
    document.getElementById('settingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        // 处理复选框
        const checkboxes = ['voice_enabled', 'auto_read', 'email_notifications', 'push_notifications', 
                           'ai_assistant_enabled', 'ai_auto_summary', 'ai_context_memory'];
        checkboxes.forEach(name => {
            data[name] = formData.has(name);
        });
        
        // 处理其他字段
        for (let [key, value] of formData.entries()) {
            if (!checkboxes.includes(key) && key !== 'csrfmiddlewaretoken') {
                data[key] = value;
            }
        }
        
        try {
            showLoading('保存设置中...');
            
            // 保存用户偏好
            const preferencesResponse = await fetch('/user/preferences/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify(data)
            });
            
            const preferencesResult = await preferencesResponse.json();
            
            // 保存AI配置
            const aiData = {
                provider: data.ai_provider,
                api_url: data.ai_api_url,
                model_id: data.ai_model_id,
                max_tokens: parseInt(data.ai_max_tokens),
                temperature: parseFloat(data.ai_temperature),
                timeout: parseInt(data.ai_timeout)
            };
            
            if (data.ai_api_key) {
                aiData.api_key = data.ai_api_key;
            }
            
            const aiResponse = await fetch('/user/ai-config/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify(aiData)
            });
            
            const aiResult = await aiResponse.json();
            
            if (preferencesResult.success && aiResult.success) {
                showSuccess('设置保存成功！');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showError('保存失败：' + (preferencesResult.message || aiResult.message));
            }
            
        } catch (error) {
            showError('保存失败：' + error.message);
        } finally {
            hideLoading();
        }
    });
    
    // 重置设置
    document.getElementById('resetSettings').addEventListener('click', function() {
        if (confirm('确定要重置所有设置吗？此操作不可撤销。')) {
            location.reload();
        }
    });
    
    // 工具函数
    function showLoading(text = '加载中...') {
        document.getElementById('loadingText').textContent = text;
        new bootstrap.Modal(document.getElementById('loadingModal')).show();
    }
    
    function hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) modal.hide();
    }
    
    function showSuccess(message) {
        showToast(message, 'success');
    }
    
    function showError(message) {
        showToast(message, 'error');
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} 
                          position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>
{% endblock %} 